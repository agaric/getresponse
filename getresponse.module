<?php

/**
 * Implements hook_menu().
 */
function getresponse_menu() {
  $items['getresponse'] = array(
    'title' => 'GetResponse',
    'route_name' => 'getresponse.settings_form',
  );
  $items['getresponse/config'] = array(
    'title' => 'Getresponse Configuration',
    'route_name' => 'getresponse.settings_form',
  );
  return $items;
}

/**
 * @param array $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param string $form_id
 */
function getresponse_form_comment_form_alter(&$form, &$form_state, $form_id) {
  if (\Drupal::currentUser()->isAnonymous() && \Drupal::config('getresponse.settings')->get('comment_on') == 1) {
    $text = \Drupal::config('getresponse.settings')->get('comment_label');
    $form['getresponse_comment_checkbox'] = array('#type' => 'checkbox', '#title' => $text);
    $form['mail'] = array('#type' => 'textfield', '#title' => 'E-mail');

    $input = $form_state->getUserInput();

    if (!empty($input) && isset($input['getresponse_comment_checkbox'])) {
      if (!empty($input['mail']) && $input['getresponse_comment_checkbox'] == 1) {
        $api_key = \Drupal::config('getresponse.settings')->get('api_key');
        $api = new Drupal\getresponse\Service\Api($api_key);
        $api->addContact(array(
          'name' => $input['name'],
          'email' => $input['mail'],
          'campaign' => array(
            'campaignId' => \Drupal::config('getresponse.settings')->get('comment_campaign')
          ),
          'customFieldValues' => array(
            array(
              'customFieldId' => getresponse_get_origin_custom_id($api_key),
              'value' => array('drupal')
            )
          )
        ));
      }
    }
  }
}

/**
 * @param string $api_key
 * @return string
 */
function getresponse_get_origin_custom_id($api_key)
{
  $api = new Drupal\getresponse\Service\Api($api_key);
  $customs = $api->getCustomFields(array('fields' => 'name'));

  foreach ($customs as $custom) {
    if ($custom->name === 'origin') {
      return $custom->customFieldId;
    }
  }

  $custom = $api->setCustomField(array(
    'name' => 'origin',
    'hidden' => FALSE,
    'type' => 'text',
    'value' => array('drupal')
  ));

  return $custom->customFieldId;
}

/**
 * @param array $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param string $form_id
 */
function getresponse_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  if (\Drupal::config('getresponse.settings')->get('register_user') == 1) {
    $text = \Drupal::config('getresponse.settings')->get('register_label');
    $form['getresponse_register_checkbox'] = array('#type' => 'checkbox', '#title' => $text);

    $input = $form_state->getUserInput();

    if (!empty($input) && isset($input['getresponse_register_checkbox']) && $input['getresponse_register_checkbox'] == 1) {
      $api_key = \Drupal::config('getresponse.settings')->get('api_key');
      $api = new Drupal\getresponse\Service\Api($api_key);
      $api->addContact(array(
        'name' => $input['name'],
        'email' => $input['mail'],
        'campaign' => array(
          'campaignId' => \Drupal::config('getresponse.settings')->get('comment_campaign')
        ),
        'customFieldValues' => array(
          array(
            'customFieldId' => getresponse_get_origin_custom_id($api_key),
            'value' => array('drupal')
          )
        )
      ));
    }
  }
}
